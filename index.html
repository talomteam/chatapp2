<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.css">
    <title>MongoChat</title>
    <style>
        #messages{height:300px;}
    </style>
</head>
<body>
    <div class="main-section">
		<div class="head-section">
			<div class="headLeft-section">
				<div class="headLeft-sub">
					<input type="text" name="search" placeholder="Search...">
					<button> <i class="fa fa-search"></i> </button>
				</div>
			</div>
			<div class="headRight-section">
				<div class="headRight-sub">
					<h3></h3>
					<small></small>
				</div>
			</div>
		</div>
		<div class="body-section">
			<div class="left-section mCustomScrollbar" data-mcs-theme="minimal-dark">
				<ul>
					
					
				</ul>
			</div>
			<div class="right-section">
				<div class="message mCustomScrollbar" data-mcs-theme="minimal-dark">
					<ul>
                            <li class="msg-left">
                                    <div class="msg-left-sub">
                                        <img src="image/man03.png">
                                        <div class="msg-desc">
                                            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
                                            tempor incididunt ut labore et dolore magna aliqua.
                                        </div>
                                        <small>05:25 am</small>
                                    </div>
                                </li>
                                <li class="msg-right">
                                    <div class="msg-left-sub">
                                        <img src="image/man04.png">
                                        <div class="msg-desc">
                                            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
                                            tempor incididunt ut labore et dolore magna aliqua.
                                        </div>
                                        <small>05:25 am</small>
                                    </div>
                                </li> 
					</ul>
				</div>
				<div class="right-section-bottom">
					<form>
						<!-- <div class="upload-btn">
						  	<button class="btn"><i class="fa fa-photo"></i></button>
						  	 <input type="file" name="myfile" /> 
						</div> -->
						<input type="text" name="message" id="message" placeholder="type here...">
						<button class="btn-send"><i class="fa fa-send"></i></button>
					</form>
				</div>
			</div>
		</div>
	</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<!-- custom scrollbar plugin -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
    <script>
      
        (function(){
            var current_groupId = '';
            var current_type = '';
            var setonclickroom = function(id){
                $("div.body-section div.left-section ul li").click(function(){
                    $( "div.body-section div.left-section ul li" ).each(function( index ) {
                        $(this).removeClass("active")
                    });
                    $(this).addClass("active")
                    name = $(this).find("div.desc h5").text()
                    $("div.headRight-section div.headRight-sub h3").text(name)

                    type = $(this).find("div.desc small:last").text()
                    $("div.headRight-section div.headRight-sub small:last").text(type)

                    current_groupId = name
                    current_type = type
                    if (current_groupId !='' ){
                        socket.emit('getmessageinroom',{
                           groupId: current_groupId,
                           type: current_type
                        })
                        $("div.right-section div.message ul li").remove()
                    }
                    
                })
            }
           
            var socket = io.connect('http://139.59.119.205:4200');
            // Check for connection
            if(socket !== undefined){
                console.log('Connected to socket...');
                // Handle Output
                socket.on('rooms', function(data){
                    console.log(data);
                    if(data.length){
                        for(var x = 0;x < data.length;x++){
                           
                            var groupTemplate = `<li>
						                    <div class="chatList">
							                    <div class="img">
								                    <i class="fa fa-circle"></i>
								                    <img src="image/man01.png">
							                    </div>
							                    <div class="desc">
								                    <small class="time"></small>
								                    <h5>{0}</h5>
								                    <small>{1}</small>
							                    </div>
						                    </div>
                                        </li>`;
                                groupTemplate = groupTemplate.replace("{0}",data[x].groupId)
                                groupTemplate = groupTemplate.replace("{1}",data[x].channel.name)
                            
                            $("div.body-section div.left-section ul").append(groupTemplate)
                        }
                        setonclickroom()
                    }
                });
                $("button.btn-send").click(function(event){
                    var message = $("input#message").val()
                    if (current_groupId !='' && message !='' ){
                        socket.emit('reply',{
                           groupId: current_groupId,
                           type: current_type,
                           message: message
                        })
                        $("input#message").val('')
                       
                    } 
                    event.preventDefault();
                });
                $("#message").keypress(function(event){
                    var message = $("input#message").val()
                    if (current_groupId !='' && message !='' ){
                        if(event.which === 13 && event.shiftKey == false){
                            socket.emit('reply',{
                            groupId: current_groupId,
                            type: current_type,
                            message: message
                            })
                            $("input#message").val('')
                        }
                    }
                });

             
                socket.on('messageinroom', function(data){
                   //$("div.right-section div.message ul li").remove()

                   if (current_groupId == data.groupId)
                   {
                       if (data.method == 'received')
                       {
                            var groupTemplate = ` <li class="msg-left">
                                            <div class="msg-left-sub">
                                                <img src="image/man03.png">
                                                <div class="msg-desc">
                                                    {0}
                                                </div>
                                                <small>{1}</small>
                                            </div>
                                        </li>`
                            groupTemplate = groupTemplate.replace("{0}",data.message.text)  
                            groupTemplate = groupTemplate.replace("{1}","")
                            $("div.right-section div.message ul").append(groupTemplate)
                       }
                       else
                       {
                        console.log("send")
                        var groupTemplate = ` <li class="msg-right">
                                            <div class="msg-left-sub">
                                                <img src="image/man03.png">
                                                <div class="msg-desc">
                                                    {0}
                                                </div>
                                                <small>{1}</small>
                                            </div>
                                        </li>`
                            groupTemplate = groupTemplate.replace("{0}",data.message.text)  
                            groupTemplate = groupTemplate.replace("{1}","")
                            $("div.right-section div.message ul").append(groupTemplate)
                       }
                   }
                   $("div.right-section").offset().top
                   console.log(data)
                });
                socket.on('firstmessageinroom', function(data){
                   //$("div.right-section div.message ul li").remove()
                   
                   if (current_groupId == data[0].groupId)
                   {    
                       msg = data[0]
                        for(var x = 0;x < msg.messages.length;x++)
                        {
                            console.log(msg.messages[x].message.text)
                            if (msg.messages[x].method == 'received')
                            {
                                    var groupTemplate = ` <li class="msg-left">
                                                    <div class="msg-left-sub">
                                                        <img src="image/man03.png">
                                                        <div class="msg-desc">
                                                            {0}
                                                        </div>
                                                        <small>{1}</small>
                                                    </div>
                                                </li>`
                                    groupTemplate = groupTemplate.replace("{0}",msg.messages[x].message.text)  
                                    groupTemplate = groupTemplate.replace("{1}","")
                                    $("div.right-section div.message ul").append(groupTemplate)
                            }
                            else
                            {
                                var groupTemplate = ` <li class="msg-right">
                                                    <div class="msg-left-sub">
                                                        <img src="image/man03.png">
                                                        <div class="msg-desc">
                                                            {0}
                                                        </div>
                                                        <small>{1}</small>
                                                    </div>
                                                </li>`
                                    groupTemplate = groupTemplate.replace("{0}",msg.messages[x].message.text)  
                                    groupTemplate = groupTemplate.replace("{1}","")
                                    $("div.right-section div.message ul").append(groupTemplate)
                            }
                        }
                        $("div.right-section").offset().top
                        console.log(data)
                    }
                        
                       
                });
                
            }
        })();
    </script>
</body>
</html>

   